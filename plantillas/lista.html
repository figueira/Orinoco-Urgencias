{% extends "base.html" %}
  {% block estilos %}
    <link rel="stylesheet" type="text/css" href="/static/css/lista.css">
  {% endblock %}

  {% block cuerpo %}
    {% if "Exitosamente" in mensaje %} 
      <div class= "alert alert-success">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        {{mensaje}}
      </div>
    {% elif "cubiculo" in mensaje %}
      <div class= "alert alert-error">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
          {{mensaje}}
        </div>
    {% endif %}

    <script src ="/static/scripts/esperas.js"> </script>
    <script>
      function enviaA(emercy){
        $(function() {
          $('#'+emercy+'cub').change(function() {
            this.form.submit();
          });
        });
      }

      {% if user.is_authenticated %}

        function actualizar(emer){
          $(function() {
            $('#formCubA_'+emer).show();
            $('#cubDir_'+emer).replaceWith($('#formCubA_'+emer));
          });
        }

      {% endif %}

      function manito(emer){
/*        $(function() {
          $(this).hover("cursor", "hand");
        });*/
      }

      // Mueve la causa de espera asignada a la lista correspondiente de causas
      // no asignadas
      function mover_a_no_asignada(espera_asignada){
        var id_espera = espera_asignada.data('id-espera');
        var no_asignadas = espera_asignada.closest('.tabla-esperas')
                                          .find('.esperas-no-asignadas')
                                          .first();
        var item_lista = $('<li></li>');
        item_lista.addClass('espera-no-asignada');
        item_lista.attr('data-id-espera', id_espera);
        no_asignadas.append(item_lista);
        
        // Colocar el logo para eliminar la causa
        var menos = $('<img> </img>');
        menos.attr('src', '/static/img/Atencion/masim.png');
        menos.addClass('espera-mas');
        item_lista.append(menos);

        // Colocar la imagen de la causa de espera
        var imagen_espera = espera_asignada.children('.imagen-espera-lista')
                                           .first();
        item_lista.append(imagen_espera);

        // Colocar la causa de espera
        item_lista.append(espera_asignada.text());

        // Eliminar la imagen de la causa de espera del td
        imagen_td = espera_asignada.closest('.causas-espera')
                                   .siblings('.imagenes-causas-espera')
                                   .children('[data-id-espera=' + 
                                             id_espera + ']')
                                   .first();
        imagen_td.remove();

        // Eliminar el elemento
        espera_asignada.remove()
      }

      $(document).ready(function(){
        // Evento que oculta el panel de causas de espera cuando se hace click
        // fuera de el
        $(document.body).click(function(){
          $('.causas-espera').fadeOut();
        })

        // Asociacion del evento click al boton de mantener un grupo  de causas
        // de espera
        $('.boton-mantener').click(function(event){
          event.preventDefault();

          MantenerEsperas($($(this).closest('.fila-emergencia')))
        })

        // Asociacion del evento click sobre las esperas
        $('.boton-espera').click(function(event){
          event.preventDefault();
          event.stopPropagation();
          var causas_espera = $(this).children('.causas-espera');
          // Decidir que hacer dependiendo de si el panel con las causas de
          // espera esta visible o no
          if(causas_espera.css('display') == 'none')
          {
            $('.causas-espera').fadeOut();
            causas_espera.fadeIn();
          } else
          {
            $('.causas-espera').fadeOut();
          }
        });

        // Esto es para prevenir que el click en el panel de causas de espera
        // haga que el mismo desaparezca
        $('.causas-espera').click(function(event){
          event.stopPropagation();
        })

        // Método que agrega causas de espera a partir de la lista de causas
        // no asignadas
        $('.causas-espera').on('click', '.espera-mas', function(event){
          // Construir el elemento a agregar a la lista de causas asignadas
          var mas_activado = $(this);
          var id_espera = mas_activado.parent().data('id-espera');
          var fila_emergencia = $(mas_activado.closest('.fila-emergencia'));
          var id_emergencia = fila_emergencia.data('id-emergencia');
          
          // Antes que todo se envia una actualizacion a la base de datos para
          // guardar este cambio
          $.getJSON('/emergencia/' + id_emergencia + '/agregar_espera/' + 
                    id_espera, '', function(id_retorno){
            var asignadas = mas_activado.closest('.tabla-esperas')
                                         .find('.esperas-asignadas')
                                         .first();
            var item_lista = $('<li></li>');
            item_lista.addClass('espera-asignada');
            item_lista.attr('data-id-espera', id_espera);
            item_lista.attr('data-id-espera-emergencia', id_retorno);
            asignadas.append(item_lista);
            
            // Colocar el logo para eliminar la causa
            var menos = $('<img> </img>');
            menos.attr('src', '/static/img/Atencion/menosim.png');
            menos.addClass('espera-menos');
            item_lista.append(menos);

            // Colocar el checkbox para marcar la causa como atendida
            var checkbox = $('<input></input>');
            checkbox.attr('type', 'checkbox');
            checkbox.addClass('espera-atendida');
            item_lista.append(checkbox);

            // Colocar la imagen de la causa de espera
            var imagen_espera = mas_activado.siblings('.imagen-espera-lista')
                                            .first();
            item_lista.append(imagen_espera.clone());

            // Colocar la causa de espera
            item_lista.append(mas_activado.parent().text());

            // Agregar la imagen de la causa de espera al td adyacente
            imagen_espera.removeClass('imagen-espera-lista');
            imagen_espera.addClass('imagen-espera-td');
            mas_activado.closest('.causas-espera')
                        .siblings('.imagenes-causas-espera')
                        .append(imagen_espera);

            // Eliminar el elemento
            mas_activado.parent().remove();

            // Finalmente indicar que se mantengan las causas de espera
            MantenerEsperas(fila_emergencia)
          });
        });

        // Método que elimina causas de espera a partir de la lista de causas
        // asignadas
        $('.causas-espera').on('click', '.espera-menos', function(event){
          var menos_activado = $(this)
            if(confirm('¿Esta seguro que desea eliminar "' + 
                       $.trim(menos_activado.parent().text()) + '"? ' +
                       "Esto no la marcará como cumplida, para ello use la " +
                       "caja adyacente"))
            {
            // Construir el elemento a agregar a la lista de causas no asignadas
            var id_espera_emergencia = menos_activado.parent()
                                                     .data('id-espera-emergencia');
            var id_emergencia = menos_activado.closest('.fila-emergencia')
                                              .data('id-emergencia');

            // Hacer peticion a la base de datos para eliminar la causa de espera
            $.get('/emergencia/eliminar_espera_emergencia/' + 
                  id_espera_emergencia, function(){
              mover_a_no_asignada(menos_activado.parent())
            });
          }
        });

        // Asociacion del evento sobre el checkbox que marca una causa de espera
        // como finalizada
        $('.esperas-asignadas').on('click', '.espera-atendida', function(){
          var checkbox_activado = $(this);
          if(confirm('¿Está seguro que desea marcar "' +
                      $.trim(checkbox_activado.parent().text()) + 
                      '" como cumplida? Esta acción no es reversible')){
            var id_espera_emergencia = checkbox_activado
                                       .parent()
                                       .data('id-espera-emergencia');

            // Hacer peticion a la base de datos para finalizar la espera
            $.get('/emergencia/espera_finalizada/' + id_espera_emergencia, 
                  function(){
              mover_a_no_asignada(checkbox_activado.parent())
            });
          } else {
            checkbox_activado.prop('checked', false)
          }
        });

        // Especialmente para Firefox, se deben asignar las propiedades
        // correctas a los checkbox y los option
        $('.espera-atendida').each(function(){
          checkbox = $(this)
          if(checkbox.attr('checked') == 'checked'){
            checkbox.prop('checked', 'checked')
          } else {
            checkbox.removeProp('checked')
          }
        });
        $('option').each(function(){
          option = $(this);
          if(option.attr('selected') == 'selected'){
            option.prop('selected', 'selected')
          }else{
            option.removeProp('selected')
          }
        })

        $(".formCubA").css("display","none");
        $("[rel='tooltip']").tooltip();
        $(".tit_list").html("{{titulo}}")
      });
    </script>


    <div class="container row">
      
      {% if emergencias %}

        <table class="table table-bordered fontsize22" >
          <tr>
            <th><center>UBICACI&Oacute;N</center></th>
            <th><center>PACIENTE</center></th>
            {% if  buscadorDeEnfermedad %}
              <th><center>DIAGNOSTICO</center></th>
            {% else %}
              <th><center>NIVEL DE TRIAGE</center></th>
            {% endif %}
            <th><center>CAUSAS DE ESPERA</center></th>
            <th>
              <center>TIEMPO DE ATENCI&Oacute;N</center>
            </th>
            <th>
            </th>
          </tr>

          {% for emergencia in emergencias %}
            <tr id ="emergencia_{{emergencia.id}}" 
                class="fila-emergencia" 
                data-id-emergencia='{{ emergencia.id }}'>
              <td>
                {% if emergencia.triage != 0 %}
                  <div id="formCub">
                    <center>
                      <form 
                        id="formCubi" 
                        method="post" 
                        action=
                          "/emergencia/guardar_cubi/{{emergencia.id}}/guardar">
                        {% csrf_token %}
                        <select name="id_cubiculo"
                                class="s1">
                          <option value="">--</option>

                          <!--Se imprime la lista de cubiculos   -->
                          
                          {% for c in cubiculos %}
                            {% if c.nombre == emergencia.cubi %}
                              <option value="{{ c.id }}" selected='selected'>
                                {{ c.nombre }}
                              </option>
                            {% else %}
                              <option value="{{ c.id }}">
                                {{ c.nombre }} 
                              </option>
                            {% endif %}
                          {% endfor %}
                        </select>
                        <button class="btn btn-mini btn-primary" 
                                onClick="enviaA('{{emergencia.id}}')" 
                                rel="tooltip" 
                                data-toggle="tooltip" 
                                data-original-title="Cambiar cubículo">
                          <i class="icon-plus-sign icon-white"></i>
                        </button>
                      </form>
                    </center>
                  </div>
                {% else %}
                  <center>SIN TRIAGE</center>
                {% endif %}
              </td>

              <td>
                <span class="nombreLista">
                  <a href='/paciente/{{ emergencia.paciente.id }}'>
                    {{emergencia.paciente}}
                  </a>
                </span>
              </td>
              
              {% if  buscadorDeEnfermedad %}

                <td >
                  <form>
                    <fieldset class= "raizSugerencias">
                      <input class="agregarEnfermedad" type="text" list="sugerencias_enfermedades" name= "enfermedad_agregada" value="" placeholder= "Ingrese el nombre de la enfermedad" autocomplete="off" >
                      <datalist id="sugerencias_enfermedades">
                      </datalist>
                    </fieldset>
                  </form>
                </td>

              {% else %}

                <td class='tdTriage'>
                  {% if emergencia.triage != 0 %}
                    <a href="/emergencia/{{emergencia.id}}/triage/calcular" 
                       rel="tooltip" 
                       data-toggle="tooltip" 
                       data-original-title="Recalcular">
                    <img 
                      src="/static/img/estados/nivel{{ emergencia.triage }}.png" 
                      class = " marginleft5 width40 height40" 
                      title="Nivel {{ emergencia.triage }}"/>
                    </a>
                  {% else %}
                    <a href="/emergencia/{{emergencia.id}}/t1">
                      <img src="/static/img/estados/nivel1.png" 
                           class = " marginleft5 width40 height40" 
                           rel="tooltip" 
                           data-toggle="tooltip" 
                           data-original-title="Colocar en Nivel 1"/>
                    </a>
                    <a href="/emergencia/{{emergencia.id}}/t2">
                      <img src="/static/img/estados/nivel2.png" 
                           class = " marginleft5 width40 height40" 
                           rel="tooltip" 
                           data-toggle="tooltip" 
                           data-original-title="Colocar en Nivel 2"/>
                    </a>
                    <a href="/emergencia/{{emergencia.id}}/triage/calcular" 
                       rel="tooltip" 
                       data-toggle="tooltip" 
                       data-original-title="Calcular">
                      <img src="/static/img/estados/nivel0.png" 
                           class = " marginleft5 width40 height40" 
                           title="Nivel {{ emergencia.triage }}"/>
                    </a>
                  {% endif %}
                </td>

              {% endif %}

              <td class='tdEspera boton-espera'>
                <div class='imagenes-causas-espera'>
                  {% for espera_emergencia in emergencia.esperas_asignadas %}
                    {% if espera_emergencia.hora_fin == None %}
                      <img class='imagen-espera-td'
                           data-id-espera='{{ espera_emergencia.espera.id }}'
                           src={{ espera_emergencia.espera.url_imagen }}
                      />
                    {% endif %}
                  {% endfor %}
                </div>
                
                <div class="causas-espera caja-dialogo">
                  <p class='titulo-esperas'>
                    <button class='btn btn-small btn-primary boton-mantener'>
                        <!--onclick='MantenerEsperas({{ emergencia.id }})'> -->
                      Mantener
                    </button>
                  </p>

                  <table class="tabla-esperas">
                    <tr>
                      <th> Causas no asignadas </th>
                      <th> Causas asignadas </th>
                    </tr>
                    <tr >
                      <td class="columna-esperas">
                        <ul class="esperas-no-asignadas">
                          {% for espera in emergencia.esperas_no_asignadas %}
                            <li class='espera-no-asignada'
                                data-id-espera='{{ espera.id }}'>
                              <img class='espera-mas'
                                   src='/static/img/Atencion/masim.png' />
                              <img class="imagen-espera-lista" 
                                   data-id-espera='{{ espera.id }}'
                                   src={{ espera.url_imagen }}
                              />
                              {{ espera.nombre }}
                            </li>
                          {% endfor %}
                        </ul>
                      </td>

                      <td class="columna-esperas">
                        <ul class="esperas-asignadas">
                          {% for espera_emergencia in emergencia.esperas_asignadas %}
                            <li class='espera-asignada'
                                data-id-espera=
                                  '{{ espera_emergencia.espera.id }}'
                                data-id-espera-emergencia=
                                  '{{ espera_emergencia.id }}'>
                              <img class='espera-menos'
                                   src='/static/img/Atencion/menosim.png' />
                              <input class='espera-atendida' 
                                     type='checkbox' />
                              <img class='imagen-espera-lista'
                                   data-id-espera=
                                     '{{ espera_emergencia.espera.id }}'
                                   src={{ espera_emergencia.espera.url_imagen }}
                              />
                              {{ espera_emergencia.espera.nombre }}
                            </li>
                          {% endfor %}
                        </ul>
                      </td>
                    </tr>
                  </table>
                </div>
              </td>

              <td>
                <div class="progress progress-striped active">
                  <div id="barra_{{ emergencia.id }}" >
                    <span id="tiempo_{{ emergencia.id }}" class = "fontsize22">
                      {{ emergencia.tiempo_esperaR }}
                    </span>
                  </div>
                </div>
              </td>

              <td>
                <a href='/emergencia/{{ emergencia.id }}/daralta' 
                   rel="tooltip" 
                   data-toggle="tooltip" 
                   data-original-title="Dar de Alta">
                  <img class = " marginleft5 width40 height40" 
                       src="/static/img/alta.png"/>
                </a>
              </td>
            </tr>
          {% endfor %}
        </table>
        
      {% else %}
        No hay pacientes en esta area
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block scripts2 %}
<script>

  $(document).ready(function() {
    $('.agregarEnfermedad').keyup(function() {
      var nombre_enfermedad= $(this).val();
      var lista_autocompletar = $(this).closest('.raizSugerencias').find('datalist');
      lista_autocompletar.empty();
      $.getJSON("/emergencia/agregarEnfermedad/"+ nombre_enfermedad, function( sugerencias ) {
        var enfermedad = JSON.parse(sugerencias);
        $.each(enfermedad,function(i){
          console.log(this.pk);
          lista_autocompletar.append('<option value = ' +this.pk + '>'
                                     +this.fields.descripcion+ '</option>') 
        });
      });
    }); 

    $('.dropdown-toggle').dropdown();
      var cont = 1;
      {% for emergencia in emergencias %}
        $("#emergencia_{{emergencia.id}}").data("tiempoEsp","{{emergencia.tiempo_espera_causasR}}");
        $("#emergencia_{{emergencia.id}}").data("fila",cont);
        $("#emergencia_{{emergencia.id}}").data("flat","0");
        cont++;
      {% endfor %}

      $('td:not(".tdEspera,.tdTriage")').click(function(){
      $('.espera').popover('hide'); 
    });

    $('.espera').click(function(e){
      e.stopPropagation();
      $('.espera').not(this).popover('hide');
    });
 

    var myVar=setInterval(function(){myTimer()},1000);
    var tiempoMax = 360;
    function myTimer() {

    {% for emergencia in emergencias %}
      var idE= "{{emergencia.paciente.apellidos}}"
      var tiempo=$("#tiempo_{{emergencia.id}}").html();
      tiempo = tiempo.split(":");
      dias = parseInt(tiempo[0]);
      hors = parseInt(tiempo[1]);
      mins = parseInt(tiempo[2]);
      segs = parseInt(tiempo[3]);
      var tiempoC = (dias*24*60)+(hors*60)+mins;

      segs += 1;

      if (segs == 60) {
        segs = segs%60;
        mins = mins +1;
        if (mins == 60) {
          mins = mins%60;
          hors = hors + 1;
          if (hors == 24) {
            hors = hors % 24;
            dias = dias + 1;
          }
        }
      }

      if (segs < 10) segs = "0"+segs;
      if (mins < 10) mins = "0"+mins;
      if (hors < 10) hors = "0"+hors;
      if (dias < 10) dias = "0"+dias;

      tiempo = dias+":"+hors+":"+mins+":"+segs;
      $("#tiempo_{{emergencia.id}}").html(tiempo);
      tiempoEsp = $("#emergencia_{{emergencia.id}}").data("tiempoEsp").split(":");
      diasEsp = parseInt(tiempoEsp[0]);
      horsEsp = parseInt(tiempoEsp[1]);
      minsEsp = parseInt(tiempoEsp[2]);
      segsEsp = parseInt(tiempoEsp[3]);
      segsEsp += 1;
      if (segsEsp == 60) {
        segsEsp = segsEsp%60;
        minsEsp = minsEsp +1;
        if (minsEsp == 60) {
          minsEsp = minsEsp%60;
          horsEsp = horsEsp + 1;
          if (horsEsp == 24) {
            horsEsp = horsEsp % 24;
            diasEsp = diasEsp + 1;
          }
        }
      }
      $("#emergencia_{{emergencia.id}}").data("tiempoEsp",diasEsp+":"+horsEsp+":"+minsEsp+":"+segsEsp)
      if (diasEsp > 0 || horsEsp> 0 || minsEsp > 0){
        $('#emergencia_{{emergencia.id}}').css("background","rgba(230, 230, 230, 0.5)");
      }

      tiempo = (dias*24*60)+(hors*60)+mins;
      tExc = tiempoMax;
      tRoj = tiempoMax * .66;
      tAma = tiempoMax * .33;
      if (tiempo  > tExc) {
        var alarma = $("#imagen_{{emergencia.id}}").attr("src");
        if (alarma != "/static/img/estados/alarmaNegra.png") {
          $("#imagen_{{emergencia.id}}").attr("src","/static/img/estados/alarmaNegra.png"); 
        }
      } else if (tiempo > tRoj) {
        $("#imagen_{{emergencia.id}}").attr("src","/static/img/estados/alarmaRoja.png");
      } else if (tiempo > tAma) {
        $("#imagen_{{emergencia.id}}").attr("src","/static/img/estados/alarmaAmarilla.png");
      }

      t = Math.floor((tiempoC /tiempoMax)*100);
      if (t >= 100) {
        $("#barra_{{emergencia.id}}").attr("class","bar bar-inverse");
      } else if (t < 100 && t >= 66) {
        $("#barra_{{emergencia.id}}").attr("class","bar bar-danger");
      } else if (t < 66 && t >= 33) {
        $("#barra_{{emergencia.id}}").attr("class","bar bar-warning");
      } else {
        $("#barra_{{emergencia.id}}").attr("class","bar bar-success");
      }

      {% endfor %}
    }
  });
</script>

{% endblock %}
