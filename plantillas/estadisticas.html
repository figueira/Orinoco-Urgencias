{% extends "base.html" %}

{% block scripts %}
  <!--Datetime Picker -->
  <script type="text/javascript" 
          src="/static/libs/datepicker/js/bootstrap-datetimepicker.min.js">
  </script>
  <link rel="stylesheet" 
        href="/static/libs/datepicker/css/bootstrap-datetimepicker.min.css">
  
  <!--Load the AJAX API-->
  <script src="/static/libs/highcharts/highcharts.js"></script>
  <script src="/static/libs/highcharts/modules/exporting.js"></script>
  <script type="text/javascript" src="/static/scripts/jsapi.js"></script>
  <script type="text/javascript">
  
    // Load the Visualization API and the piechart package.
    google.load('visualization', '1.0', {'packages':['corechart']});
  
    // Set a callback to run when the Google Visualization API is loaded.
    google.setOnLoadCallback(dibujar_graficas);
  
    // Callback that creates and populates a data table, 
    // instantiates the pie chart, passes in the data and
    // draws it.
    function dibujar_graficas() {
  
      // Create the data table.
      var data = new google.visualization.DataTable();
      data.addColumn('string', 'Topping');
      data.addColumn('number', 'Slices');
      data.addRows([
        {% for nivel,cantidad in triages %}
        ['Nivel {{nivel}}',{{cantidad}}],
        {% endfor %}
      ]);
  
      // Set chart options
  
      var options = {'width':300,
      'colors':['red','orange','yellow','green','blue'],
      'height':200};
      
  
      var data2 = google.visualization.arrayToDataTable([
        ['fecha' {% for ascii, cantidad in egresos %}, '{{ascii}}'{% endfor %}],
        ['Clasificación' {% for ascii, cantidad in egresos %}, {{cantidad}} {% endfor %}],
      ]);
  
      var options2 = {
        title: 'Total de Egresos',
        'colors':['blue','green','yellow','red','black'],
        'width':500,
      };
  
      // Instantiate and draw our chart, passing in some options.
      var chart = new google.visualization.PieChart(
                          document.getElementById('grafica_de_triages'));
      var chart2 = new google.visualization.ColumnChart(
                          document.getElementById('grafica_de_egresos'));
  
      function selectHandler() {
        var selectedItem = chart.getSelection()[0];
        if (selectedItem) {
          var topping = data.getValue(selectedItem.row, 0);
          alert('The user selected ' + topping);
        }
      }
  
      google.visualization.events.addListener(chart, 'select', selectHandler);    
      chart.draw(data, options);
      chart2.draw(data2,options2);
    }
  
  </script>
{% endblock %}

{% block cuerpo %}
  <div class="row">
    <div class="text-right">
      <a href="/estadisticas/{{inicio.day}}-{{inicio.month}}-{{inicio.year}}">
        Ver Semana Anterior
      </a> |
      <a href="/estadisticas/">
        Ver Semana Actual 
      </a> |
      <a href="/estadisticas/{{sig.day}}-{{sig.month}}-{{sig.year}}"> 
        Siguiente Semana 
      </a>
    </div>
  </div>
  <div class="row">
    <div class="span5">
      <h3>B&uacute;squeda Espec&iacute;fica</h3>
      Desde:
      <span id="fecha_inicio" class="input-append">
        <input data-format="dd-MM-yyyy" 
               placeholder="dd/mm/aaaa" 
               id="inicio" 
               type="text">
        </input>
        <span class="add-on">
          <i data-time-icon="icon-time" data-date-icon="icon-calendar">
          </i>
        </span>
      </span>
      <br/>
      <script type="text/javascript">
        $(function() {
          $('#fecha_inicio').datetimepicker({
            pickTime: false
          });
        });
      </script>
      Hasta:
      <span id="fecha_fin" class="input-append">
        <input data-format="dd-MM-yyyy" 
               placeholder="dd/mm/yyyy" 
               id="fin" 
               type="text">
        </input>
        <span class="add-on">
          <i data-time-icon="icon-time" data-date-icon="icon-calendar">
          </i>
        </span>
      </span>
      <br/>
      <script type="text/javascript">
        $(function() {
          $('#fecha_fin').datetimepicker({
            pickTime: false
          });
        });
      </script>
  
      </script>
        <div class="der">
          <a id="ir_est" href="#" class="btn btn-primary">
            Ver Per&iacute;odo
          </a>
        <script>
          $("#ir_est").click(function(){
            $("#ir_est").attr("href", "/estadisticas/" + 
                                      $("#inicio").val() + "/" + 
                                      $("#fin").val());
          });      
        </script>
      </div>
    </div>
    <div class="span5">
      <h5> Datos Generales </h5>
      Generado: <strong>{{fecha}}</strong><br/>
      Primer D&iacute;a: <strong>{{inicio}}</strong><br/>
      &Uacute;ltimo D&iacute;a: <strong>{{fin}}</strong><br/>
      Emergencias Ingresadas: <strong>{{total_ingresos}}</strong><br/>
      Emergencias Completadas: <strong>{{total_egresos}}</strong><br/>
      Emergencias : {{emergencias|last|length}}
    </div>
  </div>
  
  <hr/>
  
  <div class="row">
    <div class="span4">
      <h4>Triages Realizados</h4>
      <ul>
        {% for nivel,cantidad in triages %}
          <strong>Nivel {{nivel}}:</strong> {{cantidad}}<br/>
        {% endfor %}
      </ul>
    </div>
    <div class="span8">
      <h4>Gr&aacute;fica de Triages</h4>
      <div id="grafica_de_triages">
      </div>
    </div>
  </div>
  
  <hr/>
  <div class ="row">
    <div class="span4">
      <h4>Egresos Realizados</h4>
      <ul>
        {% for nivel,cantidad in egresos %}
          <strong>{{nivel}}:</strong> {{cantidad}}<br/>
        {% endfor %}
      </ul>
    </div>
    <div class="span8">
      <h4>Gr&aacute;fica de Egresos</h4>
      <div id="grafica_de_egresos">
      </div>
    </div>
  </div>
  
  
  <hr />
  
	  <h4> Incidencia de Causas de Espera de los Pacientes en: </h4>
    <ul class="nav nav-tabs" id="tab-de-incidencias">
    {% for color in causas%}
      {% if forloop.first %}
      <li class="active">
      {% else %}
      <li>
      {% endif %}
      <a href="#{{color.0}}">{{color.0}}</a></li>
    {% endfor %}
    </ul>
    
    
    <div class="tab-content">
      {% for color in causas %}
	{% if forloop.first %}
	  <div class="tab-pane active" id="{{color.0}}">
	{% else %}
	  <div class="tab-pane" id="{{color.0}}">    
	{% endif %}
	    <table class="table table-striped table-hover">
	      <thead>
		<tr>
		  <th>Causa de Espera</th>
		  <th>Verde (0 a 2 horas)</th>
		  <th>Amarillo (2 a 4 horas)</th>
		  <th>Rojo (4 a 6 horas)</th>
		  <th>Negro (6 o + horas)</th>
		</tr>
	      </thead>
	      {% for causa in color.1 %}
		<tr>
		  <td>
		    <a id="popover-{{color.0}}-{{causa.0}}" href="#" data-toggle="popover" title="" data-content="And here right?" data-original-title=""><img src="{{causa.1.1}}"/> {{causa.0}}</a>
		    <div style='display: none' id="chart-{{color.0}}-{{causa.0}}" style="margin: 0 auto"></div>
		  </td>
		  {% for valor in causa.1.0 %}
		    <td>{{valor}}</td>
		  {% endfor %}
		</tr>
	      {% endfor %}
	    </table>
	    <div id="chart-{{color.0}}" style="min-width: 1170px; height: 400px; margin: 0 auto"></div>
	</div>
      {% endfor %}
    </div>
 
    <hr />
	  <h4> Causas de Espera que Tuvieron Transici&oacute;n de Color de los Pacientes en: </h4>
    <ul class="nav nav-tabs" id="tab-de-incidencias-transicion">
    {% for color in causas_transicion%}
      {% if forloop.first %}
      <li class="active">
      {% else %}
      <li>
      {% endif %}
      <a href="#transicion-{{color.0}}">{{color.0}}</a></li>
    {% endfor %}
    </ul>
    
    
    <div class="tab-content">
      {% for color in causas_transicion %}
	{% if forloop.first %}
	  <div class="tab-pane active" id="transicion-{{color.0}}">
	{% else %}
	  <div class="tab-pane" id="transicion-{{color.0}}">    
	{% endif %}
	    <table class="table table-striped table-hover">
	      <thead>
		<tr>
		  <th>Causa de Espera</th>
		  <th>Amarillo (2 a 4 horas)</th>
		  <th>Rojo (4 a 6 horas)</th>
		  <th>Negro (6 o + horas)</th>
		</tr>
	      </thead>
	      {% for causa in color.1%}
		<tr>
		  <td>
		    <a id="popover-transicion-{{color.0}}-{{causa.0}}" href="#" data-toggle="popover" title="" data-content="And here right?" data-original-title=""><img src="{{causa.1.1}}"/> {{causa.0}}</a>
		    <div style='display: none' id="chart-transicion-{{color.0}}-{{causa.0}}" style="margin: 0 auto"></div>
		  </td>
		  {% for valor in causa.1.0 %}
		    <td>{{valor}}</td>
		  {% endfor %}
		</tr>
	      {% endfor %}
	    </table>
	    <div id="chart-transicion-{{color.0}}" style="min-width: 1170px; height: 400px; margin: 0 auto"></div>
	</div>
      {% endfor %}
    </div>
 
 <script>
 $(function () {
      {% for color in causas %}
        $('#chart-{{color.0}}').highcharts({
            chart: {
                type: 'column'
            },
            title: {
                text: 'Gráfica de incidencias de causa de espera por duración'
            },
            xAxis: {
                categories: [{% for color2 in causas %}
			    {% if not forloop.first %}
			    '{{color2.0}}'{% if not forloop.last %},{% endif %}
			    {% endif %}
			      {% endfor %}
			     ]
            },
            yAxis: {
                allowDecimals: false,
                min: 0,
                title: {
                    text: 'Número de incidencias'
                }
            },
            tooltip: {
                formatter: function() {
                    return '<b>'+ this.x +'</b><br/>'+
                        this.series.name +': '+ this.y
                }
            },
            series: [{% for causa in color.1 %}
		{
		name: '{{causa.0}}',
		data: {{causa.1.0}}
		}{% if not forloop.last %},{% endif %}
	    {% endfor %}]
        });
      {% endfor %}
      
      
      {% for color in causas %}
	{% for causa in color.1 %}
	  $('#chart-{{color.0}}-{{causa.0}}').highcharts({
	    chart: {
                type: 'column',
                width: 250,
                height: 300
            },
            title: {
                text: '{{causa.0}} - {{color.0}}'
            },
            xAxis: {
                categories: [{% for color2 in causas %}
			    {% if not forloop.first %}
			    '{{color2.0}}'{% if not forloop.last %},{% endif %}
			    {% endif %}
			      {% endfor %}]
            },
            yAxis: {
                allowDecimals: false,
                min: 0,
                title: {
                    text: 'Número de incidencias'
                }
            },
            tooltip: {
                formatter: function() {
                    return '<b>'+ this.x +'</b><br/>'+
                        this.series.name +': '+ this.y
                }
            },
            series: [{
		name: '{{causa.0}}',
		data: {{causa.1.0}}
	    }]
	  });
	{% endfor %}
      {% endfor %}
        
      {% for color in causas %}
	{% for causa in color.1 %}
	  $('#popover-{{color.0}}-{{causa.0}}').popover({
	    trigger: 'hover',
	    content: function() {
	      return $('#chart-{{color.0}}-{{causa.0}}').html();
	    },
	    html: true
	  });
	{% endfor %}
      {% endfor %}
    });
    
 $(function () {
      {% for color in causas_transicion %}
        $('#chart-transicion-{{color.0}}').highcharts({
            chart: {
                type: 'column'
            },
            title: {
                text: 'Gráfica de incidencias de causa de espera por duración'
            },
            xAxis: {
                categories: [{% for color2 in causas_transicion %}
			    '{{color2.0}}'{% if not forloop.last %},{% endif %}
			      {% endfor %}
			     ]
            },
            yAxis: {
                allowDecimals: false,
                min: 0,
                title: {
                    text: 'Número de incidencias'
                }
            },
            tooltip: {
                formatter: function() {
                    return '<b>'+ this.x +'</b><br/>'+
                        this.series.name +': '+ this.y
                }
            },
            series: [{% for causa in color.1 %}
		{
		name: '{{causa.0}}',
		data: {{causa.1.0}}
		}{% if not forloop.last %},{% endif %}
	    {% endfor %}]
        });
        {% endfor %}
    });
    
    
      {% for color in causas_transicion %}
	{% for causa in color.1 %}
	  $('#chart-transicion-{{color.0}}-{{causa.0}}').highcharts({
	    chart: {
                type: 'column',
                width: 250,
                height: 300
            },
            title: {
                text: '{{causa.0}} - {{color.0}}'
            },
            xAxis: {
                categories: [{% for color2 in causas_transicion %}
			    '{{color2.0}}'{% if not forloop.last %},{% endif %}
			      {% endfor %}]
            },
            yAxis: {
                allowDecimals: false,
                min: 0,
                title: {
                    text: 'Número de incidencias'
                }
            },
            tooltip: {
                formatter: function() {
                    return '<b>'+ this.x +'</b><br/>'+
                        this.series.name +': '+ this.y
                }
            },
            series: [{
		name: '{{causa.0}}',
		data: {{causa.1.0}}
	    }]
	  });
	{% endfor %}
      {% endfor %}
    
    
    
      {% for color in causas %}
	{% for causa in color.1 %}
	  $('#popover-transicion-{{color.0}}-{{causa.0}}').popover({
	    trigger: 'hover',
	    content: function() {
	      return $('#chart-transicion-{{color.0}}-{{causa.0}}').html();
	    },
	    html: true
	  });
	{% endfor %}
      {% endfor %}
</script>
 
 
 
  <script>
      $('#tab-de-incidencias a').click(function (e) {
	e.preventDefault();
	$(this).tab('show');
      })
      $('#tab-de-incidencias-transicion a').click(function (e) {
	e.preventDefault();
	$(this).tab('show');
      })
  </script>

  
{% endblock %}
